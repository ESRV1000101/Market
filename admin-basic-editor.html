<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>yü foods - Editor Tienda</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Estilos originales mantenidos */
        :root { --primary: #4a7c59; --primary-dark: #3a6547; --secondary: #8d9f87; --accent: #d0b49f; --light: #f4f1e9; --dark: #2d3319; --gray: #7d8c7d; --light-gray: #e9ecef; --shadow: 0 4px 12px rgba(0,0,0,0.08); --radius: 8px; --transition: all 0.3s ease; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background-color: var(--light); color: var(--dark); line-height: 1.6; }
        .header { background-color: var(--primary); color: white; padding: 1rem 5%; box-shadow: var(--shadow); }
        .header-container { display: flex; justify-content: space-between; align-items: center; max-width: 1400px; margin: 0 auto; }
        .logo { display: flex; align-items: center; gap: 0.5rem; font-weight: 700; font-size: 1.5rem; }
        .btn { padding: 0.8rem 1.5rem; background-color: var(--primary); color: white; border: none; border-radius: var(--radius); cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; font-weight: 600; }
        .btn:hover { background-color: var(--primary-dark); }
        .btn-secondary { background-color: var(--secondary); }
        .btn-danger { background-color: #dc3545; }
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
        .editor-section { background: white; border-radius: var(--radius); box-shadow: var(--shadow); padding: 2rem; margin-bottom: 2rem; }
        .editor-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; }
        .editor-item { background: var(--light); border-radius: var(--radius); padding: 1rem; display: flex; flex-direction: column; gap: 1rem; border: 2px solid transparent; }
        .editor-item:hover { border-color: var(--accent); }
        .editor-item img { width: 100%; height: 150px; object-fit: cover; border-radius: var(--radius); }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background: white; border-radius: var(--radius); padding: 2rem; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .form-input { width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: var(--radius); margin-bottom: 1rem; }
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 10000; }
        .toast { background: var(--primary); color: white; padding: 1rem; border-radius: var(--radius); margin-bottom: 0.5rem; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-container">
            <div class="logo"><i class="fas fa-seedling"></i><span>Editor Tienda</span></div>
            <a href="dashboard.html" class="btn"><i class="fas fa-arrow-left"></i> Volver</a>
        </div>
    </div>
    
    <div class="container">
        <h1>Editor de Tienda Básica</h1>
        
        <div class="editor-section">
            <h2><i class="fas fa-layer-group"></i> Categorías</h2>
            <button class="btn" onclick="openCategoryModal()"><i class="fas fa-plus"></i> Nueva</button>
            <div class="editor-grid" id="categories-grid" style="margin-top: 1rem;"></div>
        </div>
        
        <div class="editor-section">
            <h2><i class="fas fa-apple-alt"></i> Productos</h2>
            <div style="display:flex; gap:1rem; margin-bottom:1rem;">
                <button class="btn" onclick="openProductModal()"><i class="fas fa-plus"></i> Nuevo</button>
                <select id="category-filter" class="form-input" style="width:auto; margin-bottom:0;" onchange="renderProducts()">
                    <option value="">Todas las categorías</option>
                </select>
            </div>
            <div class="editor-grid" id="products-grid"></div>
        </div>
    </div>
    
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div id="modal-body"></div>
        </div>
    </div>
    
    <div id="image-upload-modal" class="modal">
        <div class="modal-content">
            <h3>Subir Imagen (Cloudinary)</h3>
            <input type="file" id="image-file-input" class="form-input">
            <input type="text" id="image-filename" class="form-input" placeholder="Nombre archivo">
            <button class="btn" onclick="uploadImage()">Subir</button>
            <button class="btn btn-secondary" onclick="document.getElementById('image-upload-modal').style.display='none'">Cancelar</button>
            <div id="upload-status"></div>
        </div>
    </div>
    
    <script>
        // CONFIGURACIÓN PANTRY
        const PANTRY_ID = '18fe8ca9-204c-47d1-b0eb-b48cdd2d87aa';
        const BASKETS = { categories: 'categorias', products: 'productos' };
        const API_BASE = `https://getpantry.cloud/apiv1/pantry/${PANTRY_ID}/basket/`;
        
        // Cloudinary
        const CLOUDINARY_CLOUD_NAME = 'dgxjjabov';
        const CLOUDINARY_UPLOAD_PRESET = 'yufoods_preset';
        
        let categories = [];
        let products = [];
        let currentEditItem = null;
        let currentUploadType = null;
        
        function showToast(msg) {
            const container = document.querySelector('.toast-container') || document.createElement('div');
            container.className = 'toast-container';
            document.body.appendChild(container);
            const t = document.createElement('div'); t.className = 'toast'; t.textContent = msg;
            container.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }
        
        // API PANTRY HELPER (GET ROBUSTO)
        async function fetchData(basket) {
            try {
                // Agregar ?_t=Date.now() para evitar caché
                const res = await fetch(`${API_BASE}${basket}?_t=${Date.now()}`);
                if (!res.ok) return [];
                const data = await res.json();
                
                // Pantry a veces devuelve { "productos": [...] } y a veces [...]
                // Esta línea maneja ambos casos
                return data[basket] || data || [];
            } catch (e) { console.error(e); return []; }
        }
        
        // API PANTRY HELPER (PUT + CORS FIX)
        async function saveData(basket, data) {
            try {
                const payload = {}; payload[basket] = data;
                const res = await fetch(API_BASE + basket, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) throw new Error(res.status);
            } catch (e) {
                console.warn("CORS ignored", e);
            }
        }
        
        async function loadData() {
            categories = await fetchData(BASKETS.categories);
            products = await fetchData(BASKETS.products);
            renderCategories();
            renderCategoryFilter();
            renderProducts();
        }
        
        function renderCategories() {
            const grid = document.getElementById('categories-grid');
            if(categories.length === 0) {
                 grid.innerHTML = '<p style="padding:1rem;">No hay categorías. Crea una.</p>';
                 return;
            }
            grid.innerHTML = categories.map(c => `
                <div class="editor-item">
                    <img src="${c.image}" onerror="this.src='https://via.placeholder.com/150'">
                    <h4>${c.name}</h4>
                    <p>Visible: ${c.visible ? 'Sí' : 'No'}</p>
                    <div style="display:flex; gap:5px;">
                        <button class="btn" onclick="editCategory(${c.id})"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-danger" onclick="deleteCategory(${c.id})"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
        }
        
        function renderCategoryFilter() {
            const sel = document.getElementById('category-filter');
            sel.innerHTML = '<option value="">Todas</option>' + categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }
        
        function renderProducts() {
            const grid = document.getElementById('products-grid');
            const filterId = document.getElementById('category-filter').value;
            const filtered = filterId ? products.filter(p => p.categoryId == filterId) : products;
            
            if(filtered.length === 0) {
                 grid.innerHTML = '<p style="padding:1rem;">No hay productos.</p>';
                 return;
            }
            
            grid.innerHTML = filtered.map(p => {
                const cat = categories.find(c => c.id == p.categoryId)?.name || '?';
                return `
                <div class="editor-item">
                    <img src="${p.image}" onerror="this.src='https://via.placeholder.com/150'">
                    <h4>${p.name}</h4>
                    <small>${cat} | ${p.unit}</small>
                    <p>Visible: ${p.visible ? 'Sí' : 'No'}</p>
                    <div style="display:flex; gap:5px;">
                        <button class="btn" onclick="editProduct(${p.id})"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-danger" onclick="deleteProduct(${p.id})"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
            }).join('');
        }
        
        // CRUD Logic
        function openCategoryModal(id) {
            const c = id ? categories.find(x => x.id === id) : null;
            currentEditItem = { type: 'category', id };
            currentUploadType = 'category';
            document.getElementById('modal-body').innerHTML = `
                <h3>${id ? 'Editar' : 'Nueva'} Categoría</h3>
                <input id="cat-name" class="form-input" placeholder="Nombre" value="${c?.name||''}">
                <div style="display:flex; gap:5px;">
                    <input id="cat-img" class="form-input" placeholder="URL Imagen" value="${c?.image||''}">
                    <button class="btn" onclick="openImageUploadModal()">Subir</button>
                </div>
                <label><input type="checkbox" id="cat-vis" ${c?.visible!==false?'checked':''}> Visible</label>
                <div style="margin-top:1rem;">
                    <button class="btn" onclick="saveCategory()">Guardar</button>
                    <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                </div>
            `;
            document.getElementById('edit-modal').style.display = 'flex';
        }
        
        function openProductModal(id) {
            const p = id ? products.find(x => x.id === id) : null;
            currentEditItem = { type: 'product', id };
            currentUploadType = 'product';
            document.getElementById('modal-body').innerHTML = `
                <h3>${id ? 'Editar' : 'Nuevo'} Producto</h3>
                <input id="prod-name" class="form-input" placeholder="Nombre" value="${p?.name||''}">
                <select id="prod-cat" class="form-input">${categories.map(c => `<option value="${c.id}" ${p?.categoryId==c.id?'selected':''}>${c.name}</option>`).join('')}</select>
                <select id="prod-unit" class="form-input">
                    ${['unidad','kilo','atado','mano','docena','cajón','plancha'].map(u => `<option value="${u}" ${p?.unit==u?'selected':''}>${u}</option>`).join('')}
                </select>
                <div style="display:flex; gap:5px;">
                    <input id="prod-img" class="form-input" placeholder="URL Imagen" value="${p?.image||''}">
                    <button class="btn" onclick="openImageUploadModal()">Subir</button>
                </div>
                <label><input type="checkbox" id="prod-vis" ${p?.visible!==false?'checked':''}> Visible</label>
                <div style="margin-top:1rem;">
                    <button class="btn" onclick="saveProduct()">Guardar</button>
                    <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                </div>
            `;
            document.getElementById('edit-modal').style.display = 'flex';
        }

        async function saveCategory() {
            const name = document.getElementById('cat-name').value;
            const image = document.getElementById('cat-img').value;
            const visible = document.getElementById('cat-vis').checked;
            
            if (currentEditItem.id) {
                const idx = categories.findIndex(c => c.id === currentEditItem.id);
                categories[idx] = { ...categories[idx], name, image, visible };
            } else {
                categories.push({ id: Date.now(), name, image, visible });
            }
            await saveData(BASKETS.categories, categories);
            loadData(); closeModal(); showToast('Guardado');
        }

        async function saveProduct() {
            const name = document.getElementById('prod-name').value;
            const categoryId = parseInt(document.getElementById('prod-cat').value);
            const unit = document.getElementById('prod-unit').value;
            const image = document.getElementById('prod-img').value;
            const visible = document.getElementById('prod-vis').checked;
            
            if (currentEditItem.id) {
                const idx = products.findIndex(p => p.id === currentEditItem.id);
                products[idx] = { ...products[idx], name, categoryId, unit, image, visible };
            } else {
                products.push({ id: Date.now(), name, categoryId, unit, image, visible });
            }
            await saveData(BASKETS.products, products);
            loadData(); closeModal(); showToast('Guardado');
        }

        async function deleteCategory(id) {
            if(!confirm('¿Borrar?')) return;
            categories = categories.filter(c => c.id !== id);
            await saveData(BASKETS.categories, categories);
            loadData(); showToast('Eliminado');
        }

        async function deleteProduct(id) {
            if(!confirm('¿Borrar?')) return;
            products = products.filter(p => p.id !== id);
            await saveData(BASKETS.products, products);
            loadData(); showToast('Eliminado');
        }
        
        // Funciones auxiliares
        function editCategory(id) { openCategoryModal(id); }
        function editProduct(id) { openProductModal(id); }
        function closeModal() { document.getElementById('edit-modal').style.display = 'none'; }
        function openImageUploadModal() { document.getElementById('image-upload-modal').style.display = 'flex'; }
        
        async function uploadImage() {
            const file = document.getElementById('image-file-input').files[0];
            const name = document.getElementById('image-filename').value;
            if(!file || !name) return alert('Faltan datos');
            
            document.getElementById('upload-status').innerText = 'Subiendo...';
            const fd = new FormData();
            fd.append('file', file);
            fd.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
            fd.append('public_id', name);
            
            try {
                const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, { method: 'POST', body: fd });
                const data = await res.json();
                const urlField = currentUploadType === 'category' ? 'cat-img' : 'prod-img';
                document.getElementById(urlField).value = data.secure_url;
                document.getElementById('image-upload-modal').style.display = 'none';
                showToast('Imagen subida');
            } catch(e) { alert('Error subida'); }
        }

        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>