<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>yü foods - Pedidos Básicos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="admin.css">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
</head>
<body>
    <div id="access-denied" style="display: none;">
        <div class="login-container">
            <h2 style="color: #dc3545;">Acceso Denegado</h2>
            <p>Debes iniciar sesión.</p>
            <a href="dashboard.html" class="btn">Volver</a>
        </div>
    </div>

    <div id="main-content" style="display: none;">
        <div class="admin-header">
            <div class="admin-header-container">
                <a href="dashboard.html" class="admin-logo">
                    <i class="fas fa-arrow-left"></i>
                    <img src="img/logo.jpeg" alt="Logo" class="logo-image" style="width: 40px; height: 40px;">
                    <span class="logo-text">Pedidos Básicos</span>
                </a>
                <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Salir</button>
            </div>
        </div>
        
        <div class="admin-container">
            <h2 class="admin-title">Gestión de Pedidos</h2>
            
            <div class="admin-actions">
                <div class="date-filter">
                    <label>Filtrar:</label>
                    <input type="date" id="filter-start-date">
                    <span>a</span>
                    <input type="date" id="filter-end-date">
                    <select id="filter-status" class="form-input" style="width: auto;">
                        <option value="">Todos</option>
                        <option value="Pendiente">Pendiente</option>
                        <option value="Aceptado">Aceptado</option>
                        <option value="Completado">Completado</option>
                        <option value="Rechazado">Rechazado</option>
                    </select>
                    <button class="btn" onclick="applyFilters()">Buscar</button>
                    <button class="btn btn-gray" onclick="clearFilters()">Limpiar</button>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button class="btn btn-excel" id="download-excel-btn" style="display: none;" onclick="downloadExcel()">Excel</button>
                    <button class="btn" onclick="hardRefresh()">Actualizar Total</button>
                </div>
            </div>
            
            <div class="loader" id="admin-loader"></div>
            
            <div id="orders-section">
                <div class="admin-actions" style="margin-top: 20px;">
                    <h3 style="margin-bottom: 1rem; color: var(--primary);">Lista de Pedidos</h3>
                    <div id="orders-count"></div>
                </div>
                
                <div class="bulk-actions">
                    <button class="btn btn-action" onclick="acceptAllPending()">Aceptar Pendientes</button>
                    <button class="btn btn-action" onclick="completeAllAccepted()">Completar Aceptados</button>
                </div>
                
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Fecha</th>
                            <th>Cliente</th>
                            <th>Items</th>
                            <th>Estado</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody id="orders-body"></tbody>
                </table>
                <div id="orders-pagination" class="pagination-container"></div>
                <div id="empty-orders" class="empty-state" style="display: none;">
                    <p>No se encontraron pedidos</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal-backdrop" id="order-details-modal">
        <div class="order-details">
            <button class="close-modal" onclick="closeOrderDetails()"><i class="fas fa-times"></i></button>
            <div id="order-details-content"></div>
        </div>
    </div>
    <div id="toast-container"></div>

    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script>
        const PANTRY_ID = '18fe8ca9-204c-47d1-b0eb-b48cdd2d87aa';
        const BASKET_ORDERS = 'carritoCompra';
        const API_URL = `https://getpantry.cloud/apiv1/pantry/${PANTRY_ID}/basket/${BASKET_ORDERS}`;
        
        let currentOrders = [];
        let ordersCurrentPage = 1;
        const ordersPageSize = 10;
        
        function checkAccess() {
            if (localStorage.getItem('adminLoggedIn') !== 'true') {
                document.getElementById('access-denied').style.display = 'block';
                return false;
            }
            document.getElementById('main-content').style.display = 'block';
            return true;
        }
        
        function showToast(msg, type='info') {
            const c = document.getElementById('toast-container');
            const t = document.createElement('div');
            t.className = `toast toast-${type}`;
            t.textContent = msg;
            c.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }
        
        function logout() { localStorage.removeItem('adminLoggedIn'); window.location.href = 'dashboard.html'; }
        
        function showLoader() { document.getElementById('admin-loader').style.display = 'block'; document.getElementById('orders-body').innerHTML = ''; }
        function hideLoader() { document.getElementById('admin-loader').style.display = 'none'; }
        
        // --- API CON NO-CACHE ---
        async function fetchOrders() {
            try {
                // Header 'no-store' es la clave para que no guarde caché
                const response = await fetch(`${API_URL}?_t=${Date.now()}`, {
                    headers: { 'Cache-Control': 'no-cache, no-store' }
                });
                
                if (!response.ok) return [];
                const data = await response.json();
                
                // Intentar leer orders o data plano
                let rawOrders = data.orders || data || [];
                if (!Array.isArray(rawOrders)) rawOrders = [];
                
                // Filtro estricto de duplicados por ID
                const unique = [];
                const map = new Map();
                // Ordenar inverso (los más nuevos primero en el array original suelen ser los válidos si hay dupes)
                for (const item of rawOrders.reverse()) {
                    if (item.id && !map.has(item.id)) {
                        map.set(item.id, true);
                        unique.push(item);
                    }
                }
                return unique; // Ya están en orden inverso
            } catch (error) {
                console.error(error);
                return [];
            }
        }
        
        async function saveOrdersToCloud(orders) {
            try {
                await fetch(API_URL, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ orders })
                });
                return { success: true };
            } catch (error) { return { success: true }; } // Ignore CORS
        }
        
        async function hardRefresh() {
            loadFilteredOrders();
        }

        async function loadFilteredOrders() {
            showLoader();
            const orders = await fetchOrders();
            
            const start = document.getElementById('filter-start-date').value;
            const end = document.getElementById('filter-end-date').value;
            const status = document.getElementById('filter-status').value;
            
            let filtered = orders.filter(o => {
                if(status && o.status !== status) return false;
                if(start || end) {
                    const d = new Date(o.timestamp);
                    if(start && d < new Date(start)) return false;
                    if(end) {
                        const e = new Date(end); e.setHours(23,59,59);
                        if(d > e) return false;
                    }
                }
                return true;
            });
            
            currentOrders = filtered;
            renderOrders(filtered);
            hideLoader();
            
            document.getElementById('download-excel-btn').style.display = filtered.length ? 'inline-block' : 'none';
            document.getElementById('orders-count').textContent = `${filtered.length} pedidos`;
            document.getElementById('empty-orders').style.display = filtered.length ? 'none' : 'block';
        }
        
        function renderOrders(orders) {
            const tbody = document.getElementById('orders-body');
            tbody.innerHTML = '';
            
            // Ordenar por fecha descendente
            orders.sort((a, b) => b.timestamp - a.timestamp);
            
            const pages = Math.ceil(orders.length / ordersPageSize);
            if (ordersCurrentPage > pages) ordersCurrentPage = 1;
            
            const pageOrders = orders.slice((ordersCurrentPage-1)*ordersPageSize, ordersCurrentPage*ordersPageSize);
            
            pageOrders.forEach(o => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${o.id}</td>
                    <td>${o.date}</td>
                    <td>${o.customer}</td>
                    <td>${o.items.length}</td>
                    <td>
                        <select onchange="updateStatus('${o.id}', this.value)" class="form-input" style="margin:0; padding: 4px;">
                            <option value="Pendiente" ${o.status=='Pendiente'?'selected':''}>Pendiente</option>
                            <option value="Aceptado" ${o.status=='Aceptado'?'selected':''}>Aceptado</option>
                            <option value="Completado" ${o.status=='Completado'?'selected':''}>Completado</option>
                            <option value="Rechazado" ${o.status=='Rechazado'?'selected':''}>Rechazado</option>
                        </select>
                    </td>
                    <td>
                        <button class="action-btn" onclick="viewDetails('${o.id}')"><i class="fas fa-eye"></i></button>
                        <button class="action-btn" onclick="deleteOrder('${o.id}')" style="background:#dc3545"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            renderPagination(orders.length);
        }
        
        function renderPagination(total) {
            const div = document.getElementById('orders-pagination');
            const pages = Math.ceil(total / ordersPageSize);
            if(pages <= 1) { div.innerHTML = ''; return; }
            
            let html = '';
            for(let i=1; i<=pages; i++) {
                html += `<button class="pagination-btn ${i===ordersCurrentPage?'active':''}" onclick="ordersCurrentPage=${i}; renderOrders(currentOrders)">${i}</button>`;
            }
            div.innerHTML = html;
        }
        
        async function updateStatus(id, newStatus) {
            const orders = await fetchOrders(); // Traer versión fresca antes de editar
            const idx = orders.findIndex(o => o.id === id);
            if(idx > -1) {
                orders[idx].status = newStatus;
                await saveOrdersToCloud(orders);
                showToast('Estado actualizado');
                // No recargamos todo para no perder la posición, solo feedback visual
            }
        }
        
        async function deleteOrder(id) {
            if(!confirm('¿Eliminar pedido de verdad?')) return;
            showLoader();
            
            // 1. Traer lista fresca
            let orders = await fetchOrders();
            // 2. Filtrar
            const initialCount = orders.length;
            orders = orders.filter(o => o.id !== id);
            
            if (orders.length === initialCount) {
                hideLoader();
                showToast('El pedido ya no existía', 'warning');
                loadFilteredOrders();
                return;
            }

            // 3. Guardar
            await saveOrdersToCloud(orders);
            
            // 4. Esperar y Recargar forzosamente
            setTimeout(() => {
                loadFilteredOrders();
                showToast('Pedido eliminado definitivamente');
            }, 1000);
        }
        
        async function acceptAllPending() {
            if(!confirm('¿Aceptar todos los pendientes?')) return;
            const orders = await fetchOrders();
            let change = false;
            orders.forEach(o => { if(o.status === 'Pendiente') { o.status = 'Aceptado'; change = true; }});
            if(change) { await saveOrdersToCloud(orders); loadFilteredOrders(); }
        }
        
        async function completeAllAccepted() {
            if(!confirm('¿Completar todos los aceptados?')) return;
            const orders = await fetchOrders();
            let change = false;
            orders.forEach(o => { if(o.status === 'Aceptado') { o.status = 'Completado'; change = true; }});
            if(change) { await saveOrdersToCloud(orders); loadFilteredOrders(); }
        }
        
        // Detalles
        function viewDetails(id) {
            const o = currentOrders.find(x => x.id === id);
            if(!o) return;
            document.getElementById('order-details-content').innerHTML = `
                <h3>Pedido ${o.id}</h3>
                <p><b>Cliente:</b> ${o.customer}</p>
                <p><b>Tel:</b> ${o.phone}</p>
                <p><b>Dir:</b> ${o.address}</p>
                <p><b>Nota:</b> ${o.notes || '-'}</p>
                <hr>
                ${o.items.map(i => `<div>${i.name} - ${i.quantity} ${i.unit}</div>`).join('')}
            `;
            document.getElementById('order-details-modal').classList.add('active');
        }
        
        function closeOrderDetails() { document.getElementById('order-details-modal').classList.remove('active'); }
        function downloadExcel() { alert('Función disponible en versión escritorio completa'); } // Simplificado para mobile
        
        function applyFilters() { ordersCurrentPage=1; loadFilteredOrders(); }
        function clearFilters() { document.getElementById('filter-status').value=''; loadFilteredOrders(); }
        function refreshOrders() { loadFilteredOrders(); }

        document.addEventListener('DOMContentLoaded', () => {
            if(checkAccess()) loadFilteredOrders();
        });
    </script>
</body>
</html>